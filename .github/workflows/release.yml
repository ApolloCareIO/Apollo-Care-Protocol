# Apollo Care Protocol - Release Workflow
#
# Triggered on version tags (v*.*.*) or manual dispatch
# - Builds production binaries
# - Generates IDLs
# - Creates GitHub release with artifacts
# - Optionally deploys to devnet

name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      deploy_devnet:
        description: 'Deploy to devnet after build'
        required: false
        default: 'false'
        type: boolean
      version:
        description: 'Version tag (e.g., v0.1.0)'
        required: false
        type: string

env:
  SOLANA_VERSION: "1.18.26"
  ANCHOR_VERSION: "0.29.0"
  RUST_TOOLCHAIN: "1.75.0"

jobs:
  # ============================================
  # Build Release Artifacts
  # ============================================
  build-release:
    name: Build Release
    runs-on: ubuntu-latest
    
    outputs:
      version: ${{ steps.version.outputs.version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.ref_name }}" ] && [[ "${{ github.ref_name }}" == v* ]]; then
            echo "version=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=v0.0.0-dev" >> $GITHUB_OUTPUT
          fi

      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v${{ env.SOLANA_VERSION }}/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Install Anchor CLI
        run: |
          cargo install --git https://github.com/coral-xyz/anchor avm --locked --force
          avm install ${{ env.ANCHOR_VERSION }}
          avm use ${{ env.ANCHOR_VERSION }}
          echo "$HOME/.avm/bin" >> $GITHUB_PATH

      - name: Generate keypair
        run: solana-keygen new --no-bip39-passphrase -s -o ~/.config/solana/id.json

      - name: Build release
        run: anchor build --verifiable

      - name: Package artifacts
        run: |
          mkdir -p release
          cp target/deploy/*.so release/
          cp -r target/idl release/
          cp -r target/types release/ 2>/dev/null || true
          echo "${{ steps.version.outputs.version }}" > release/VERSION
          tar -czvf apollo-care-protocol-${{ steps.version.outputs.version }}.tar.gz release/

      - name: Upload release artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-${{ steps.version.outputs.version }}
          path: apollo-care-protocol-*.tar.gz
          retention-days: 30

  # ============================================
  # Create GitHub Release
  # ============================================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build-release
    if: startsWith(github.ref, 'refs/tags/v')
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-${{ needs.build-release.outputs.version }}

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Apollo Care Protocol ${{ needs.build-release.outputs.version }}
          body: |
            ## Apollo Care Protocol ${{ needs.build-release.outputs.version }}
            
            ### Programs
            - `apollo_core` - Shared constants & Token-2022 config
            - `apollo_membership` - Member enrollment & contributions
            - `apollo_reserves` - USDC reserve management
            - `apollo_risk_engine` - Actuarial pricing & CAR
            - `apollo_claims` - Claims processing & AI oracle
            - `apollo_governance` - DAO & committee governance
            - `apollo_staking` - APH staking mechanics
            - `apollo_reinsurance` - Reinsurance & recovery
            
            ### Verification
            All programs built with `anchor build --verifiable`
            
            See [CHANGELOG.md](CHANGELOG.md) for details.
          files: |
            apollo-care-protocol-*.tar.gz
          draft: false
          prerelease: ${{ contains(needs.build-release.outputs.version, '-') }}

  # ============================================
  # Deploy to Devnet (Optional)
  # ============================================
  deploy-devnet:
    name: Deploy to Devnet
    runs-on: ubuntu-latest
    needs: build-release
    if: github.event.inputs.deploy_devnet == 'true'
    environment: devnet
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-action@stable
        with:
          toolchain: ${{ env.RUST_TOOLCHAIN }}

      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v${{ env.SOLANA_VERSION }}/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Install Anchor CLI
        run: |
          cargo install --git https://github.com/coral-xyz/anchor avm --locked --force
          avm install ${{ env.ANCHOR_VERSION }}
          avm use ${{ env.ANCHOR_VERSION }}
          echo "$HOME/.avm/bin" >> $GITHUB_PATH

      - name: Configure devnet wallet
        run: |
          echo "${{ secrets.DEVNET_DEPLOYER_KEYPAIR }}" > ~/.config/solana/id.json
          solana config set --url devnet

      - name: Build programs
        run: anchor build

      - name: Deploy to devnet
        run: anchor deploy --provider.cluster devnet
        env:
          ANCHOR_WALLET: ~/.config/solana/id.json
